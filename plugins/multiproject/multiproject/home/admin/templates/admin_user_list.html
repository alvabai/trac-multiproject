<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
    <xi:include href="admin.html" />
    <xi:include href="pagination.html" />

    <!-- List users. -->
    <head>
        <title>Users</title>
        <script type="text/javascript">
        $(document).ready(function(){
            // User autocomplete
            var element = $('input#usersearch');
            var userfield = new multiproject.ui.UserField(element);

            // Instructions for Transparency how to render fields
            var directives = {
                'username':function(element) { return this.firstname + ' ' + this.lastname + ' (' + this.username + ')' },
                'username@href':function(element) {
                    return multiproject.req.base_path  + '/admin/users/manage?username=' + this.username;
                },
                'expires':function(element) {
                    return this.expires ? new Date(Date.parse(this.expires)).toDateString() : '';
                }
            };

            // On select, open user edit
            userfield.onSelect = function(event, ui) {
                element.addClass('loading');
                window.location = multiproject.req.base_path  + "/admin/users/manage?username=" + ui.item.username;
            };
            // Modify request
            userfield.onRequest = function (request, response) {
                // Show loader class until response is shown
                element.addClass('loading');
                var keyword = element.val();
                var status = $('select#status option:selected').attr('name');
                var auth = $('select#auth option:selected').attr('name');
                // Make AJAX request to fetch users
                $.getJSON(multiproject.req.base_path + "/userautocomplete", {
                    q:keyword, field:'id,username,firstname,lastname,email,mobile', status:status, auth:auth, perm:'USER_MODIFY'}, function(data){
                    // Always return empty: we don't need autocomplete in this case but render the table instead
                    response({});
                    $('tbody.users').render(data, directives);

                    element.removeClass('loading');
                });
            };

            // Render field, run initial search and move focus to it
            userfield.render({minLength:0});
            element.autocomplete('search');
            element.focus();

            // Run autocomplete also when selection is changed
            $('select#status').change(function(){ element.autocomplete('search'); });
            $('select#auth').change(function(){ element.autocomplete('search'); });
        });
        </script>
    </head>

    <body>
     <h2>Users</h2>
     <div id="content">
         <p>Find account(s) using the filters below. Maximum number of results is 30 - give more detailed filters to
         limit down the results</p>
         <div class="search">
             <label for="usersearch">Filter</label>
             <input id="usersearch" size="50" type="text" placeholder="Filter with name, username or email" />
             <select id="status" name="status">
                 <option name="">All states</option>
                 <option name="expired">Expired</option>
                 <option name="${sname}" py:for="skey, sname in states.items()">${sname.title()}</option>
             </select>
             <select id="auth" name="auth">
                 <option name="">All accounts</option>
                 <!--! Show last entry from organization value -->
                 <option name="${orgk}" py:for="orgk, orgv in organizations.items()">${orgv[-1]}</option>
             </select>
         </div>

         <hr />

        <table class="table">
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Mobile</th>
                <th>Expires</th>
            </tr>
            <tbody class="users">
                <tr>
                    <td><a class="username"></a></td>
                    <td class="email"></td>
                    <td class="mobile"></td>
                    <td class="expires"></td>
                </tr>
            </tbody>
        </table>
    </div>
  </body>
</html>
