*** Settings ***
Library        Collections
Library        HttpLibrary.HTTP
Library        htlib
Resource       ../common_keywords.txt

*** Keywords ***

Change project description
  [Arguments]  ${project}  ${new_description}
  Mypost  /${project}/admin  form_values=icon=&name=foo&author_id=4&created=2013-03-04 18:33:58&published=2013-03-04 18:33:59&descr=${new_description}&apply=Apply changes


Change project visibility
  [Documentation]  Make project private or public and test if succeeded.
  ...              Arguments: project name and "private" or "public"
  [Arguments]  ${project}  ${visibility}
  Myget   /${project}/admin/general/permissions
  Mypost  /${project}/admin/general/permissions  make${visibility}=Make ${visibility}
  ${body}=  Get Response Body
  Element Should contain  ${body}  p  Project is currently: <strong>${visibility}</strong>

Login
  [Documentation]  Send a HTTP GET request, sending and storing all the cookies.
  [Arguments]  ${login_url}=/  ${params}=${EMPTY}
  Create HTTP Context  ${SERVER}  https
  GET  ${login_url}
  ${status}=  Get Response Status
  Run Keyword If  '${status}' == '302 Found'  Follow Response
  Save cookies
  Mypost  /home/user  username=${VALID_USER}&password=${VALID_PASSWD}&login=Login&action=do_login


Setup and login
  [Documentation]  Create a suite-level variable ${suite_cookies},
  ...              which is used to hold cookies during test suite.
  ${suite_cookies}=  Create Dictionary
  Set Suite Variable  ${suite_cookies}
  Login


Setup and create project
  [Documentation]  Create a new project with svn repo and if succeeded, save its name
  ...              to a suite variable ${suite_project}.
  Setup and login
  ${suite_project}=  Get Unique Project Name
  Create new project  ${suite_project}  ${suite_project}-svn  svn
  ${body}=  Get Response Body
  Element Should contain  ${body}  title  ${suite_project}
  Set Suite Variable  ${suite_project}


Logout
  Myget  /home/user?action=logout

Myget
  [Documentation]  Make a GET request to the given url.
  [Arguments]  ${url}=/home
  ${cookie_hdrs}=  Get Cookie Header  ${suite_cookies}
  Set Request Header  Cookie  ${cookie_hdrs}
  GET  ${url}
  Log  ${url}
  Save cookies


Mypost
  [Documentation]  Make a POST request to the given url with given arguments. All form values except the form_token should be given as the second argument, separated with ampersands.
  [Arguments]  ${url}  ${form_values}
  ${form_token}=  Get From Dictionary  ${suite_cookies}  trac_form_token
  ${cookie_hdrs}=  Get Cookie Header  ${suite_cookies}
  Set Request Header  Cookie  ${cookie_hdrs}
  Set Request Body  __FORM_TOKEN=${form_token}&${form_values}
  POST  ${url}
  Save cookies
  ${status}=  Get Response Status
  Run Keyword If  '${status}' == '302 Found'  Follow Response
  Run Keyword If  '${status}' == '303 See Other'  Follow Response


Save cookies
  [Documentation]  Save current cookies. Note that path information is not considered, so cookies with same name but different path-attributes override each other.
  ${headers}=  Get Response Header  set-cookie
  ${cookies}=  Headers to Dict  ${headers}  key=trac
  Update Dictionary  ${suite_cookies}  ${cookies}


Create new project
  [Documentation]  Create a new project. Arguments: project name and type (svn,hg,git)
  [Arguments]  ${proj}  ${reponame}  ${type}=svn
  Myget  /home/project
  Remove from dictionary  ${suite_cookies}  trac_session 
  Mypost  /home/project/create  action=create&prj_long_name=${proj}&prj_short_name=${proj}&prj_description=Just_a_dummy_description&prj_is_public=on&scm_source=create&vcstype=${type}&vcs_name=${reponame}


Element Should contain
  [Documentation]  Check that in the content, some of the given element's
  ...              children contains the given string.
  [Arguments]  ${body}  ${element}  ${content}
  ${body}=  Convert To String  ${body})
  htlib.Element Should contain  ${body}  ${element}  ${content}

# vim: syntax=robot
